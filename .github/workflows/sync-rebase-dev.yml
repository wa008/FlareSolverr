name: Sync dev with Upstream master

on:
  # 1. Manual Trigger (now reads from 'dev' branch)
  workflow_dispatch:
  
  # 2. Scheduled Trigger (now reads from 'dev' branch)
  schedule:
    - cron: '0 9 * * *'

jobs:
  rebase-workflow:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Check out your 'dev' branch
      # (This happens by default because 'dev' is now the default branch)
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }} 

      # 2. Configure Git User
      - name: Set Git user
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # 3. Add the Upstream Remote
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/FlareSolverr/FlareSolverr.git
          
      # 4. Fetch all updates from the upstream remote
      - name: Fetch upstream
        run: git fetch upstream

      # --- KEY SYNC STEP ---
      # No more 'master' branch logic. We rebase 'dev' directly.

      # 5. Rebase 'dev' branch onto 'upstream/master'
      - name: Rebase dev branch
        run: |
          # Rebase the current branch (dev) directly onto upstream/master
          # This command will fail (exit non-zero) if conflicts are found
          git rebase upstream/master
            
      # 6. Push rebased branch (only runs if Step 5 succeeded)
      - name: Push rebased branch
        run: |
          # Push the changes to your 'dev' branch
          # Use --force-with-lease for a safer force push
          git push origin dev --force-with-lease
          
      # 7. Notify on Conflict (only runs if Step 5 failed)
      - name: Notify on conflict
        if: failure()
        run: |
          echo "!!! REBASE CONFLICT !!!"
          echo "Automatic rebase failed. Please resolve conflicts manually."
          echo "Visit the 'Actions' tab in your repo for details."
          exit 1
